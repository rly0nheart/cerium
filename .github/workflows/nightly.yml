name: Nightly Build

permissions:
  contents: write

on:
  schedule:
    # Run at midnight UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  # Run tests and capture results
  test:
    runs-on: ubuntu-latest
    outputs:
      test_results: ${{ steps.test.outputs.results || steps.skip_test.outputs.results }}
      test_passed: ${{ steps.test.outputs.passed || steps.skip_test.outputs.passed }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install libmagic
        run: |
          chmod +x scripts/install-libmagic.sh
          ./scripts/install-libmagic.sh

      - name: Run tests
        id: test
        if: ${{ github.event.inputs.skip_tests != 'true' }}
        run: |
          # Run tests and capture output
          set +e
          TEST_OUTPUT=$(cargo test --all-features 2>&1)
          TEST_EXIT_CODE=$?
          set -e

          # Sum results across ALL test binaries
          PASSED=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= passed)' | awk '{s+=$1} END {print s+0}')
          FAILED=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= failed)' | awk '{s+=$1} END {print s+0}')
          IGNORED=$(echo "$TEST_OUTPUT" | grep -oP '\d+(?= ignored)' | awk '{s+=$1} END {print s+0}')

          # Build results summary
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            RESULTS="**All tests passed**\n- Passed: $PASSED\n- Ignored: $IGNORED"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            RESULTS="**Some tests failed**\n- Passed: $PASSED\n- Failed: $FAILED\n- Ignored: $IGNORED"
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

          # Handle multi-line output
          echo "results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Set skipped test results
        id: skip_test
        if: ${{ github.event.inputs.skip_tests == 'true' }}
        run: |
          echo "results=**Tests skipped**" >> $GITHUB_OUTPUT
          echo "passed=true" >> $GITHUB_OUTPUT

  # Build for Linux
  build:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: x86_64-unknown-linux-gnu

      - name: Install libmagic
        run: |
          chmod +x scripts/install-libmagic.sh
          ./scripts/install-libmagic.sh

      - name: Build
        run: cargo build --release --all-features --target x86_64-unknown-linux-gnu

      - name: Prepare artifact
        run: |
          mkdir -p dist
          cp target/x86_64-unknown-linux-gnu/release/ce dist/ce-linux-x86_64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ce-linux-x86_64
          path: dist/ce-linux-x86_64

  # Create nightly release
  release:
    needs: [test, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/

      - name: Get version and date info
        id: info
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          DATE=$(date -u +%Y-%m-%d)
          DATE_COMPACT=$(date -u +%Y%m%d)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          TAG="v${VERSION}-nightly.${DATE_COMPACT}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Get commits since last nightly
        id: changelog
        run: |
          # Find the most recent nightly tag
          LAST_NIGHTLY=$(git tag -l 'v*-nightly.*' --sort=-version:refname | head -1)

          if [ -z "$LAST_NIGHTLY" ]; then
            # No previous nightly, get recent commits (limit to 5)
            COMMITS=$(git log --oneline -5 --format="- %h %s")
            HEADER="### Recent Commits (last 5)"
          else
            # Get commits since last nightly
            COMMITS=$(git log --oneline "${LAST_NIGHTLY}..HEAD" --format="- %h %s")
            HEADER="### Changes since ${LAST_NIGHTLY}"
          fi

          # Handle empty commits
          if [ -z "$COMMITS" ]; then
            COMMITS="No new commits"
          fi

          # Handle multi-line output
          echo "header=$HEADER" >> $GITHUB_OUTPUT
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create nightly release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.info.outputs.tag }}
          name: ${{ steps.info.outputs.tag }}
          body: |
            ## Nightly Build

            **Date:** ${{ steps.info.outputs.date }}
            **Version:** ${{ steps.info.outputs.version }}
            **Commit:** ${{ steps.info.outputs.commit }}

            ---

            ${{ steps.changelog.outputs.header }}

            ${{ steps.changelog.outputs.commits }}

            ---

            ### Test Results

            ${{ needs.test.outputs.test_results }}

            ---

            ### Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x86_64 | `ce-linux-x86_64` |

            ---

            > **Warning:** This is an automated nightly build and may be unstable.
            > For stable releases, please use the [latest stable release](../../releases/latest).
          files: release/*
          prerelease: true
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}